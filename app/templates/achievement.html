<% extends "head.html" %>
  <% block content %>

    <!-- chart.js -->
    <script src="../static//library/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.0/lib/bundle.min.js"></script>

    <style>
      .card-header {
        background-color: #ccecf1;
        font-size: 18px;
      }
    </style>

    <div id="app" v-clock>
      <div v-if="pageName=='index'">
        <b-card class="fixed-top header" style="background: rgba(255,255,255,0.5);">
          <b-row>
            <b-col></b-col>
            <b-col cols="11">
              <b-row>
                <b-col>
                </b-col>
                <!-- サイドバー -->
                <b-col class="text-right">
                  <sc-menu v-if="modeName!='mw'"></sc-menu>
                </b-col>
              </b-row>
            </b-col>
            <b-col></b-col>
          </b-row>
        </b-card>

        <!-- 空行 -->
        <b-row class="mb-5"></b-row>
        <b-row class="mb-5"></b-row>

        <div>
          <b-row class="mt-1">
            <b-col></b-col>
            <b-col cols="11">
              <b-card border-variant="white" class="mb-3 text-center" header="月別売上推移表" header-border-variant="light">
                <b-row>
                  <b-col>
                    <b-form-input v-model="year" id="year" size="sm" placeholder="年">
                    </b-form-input>
                  </b-col>
                  <b-col>
                    <b-form-input v-model="month" id="month" size="sm" placeholder="期首">
                    </b-form-input>
                  </b-col>
                  <b-col>
                    <b-button variant="primary" size="sm" @click="getAchievements(year,month);">検索</b-button>
                  </b-col>
                </b-row>
                <b-row>
                  <p class="mr-3"> ○○○○年度 ○○月～○○月 </p>
                </b-row>
                <b-table responsive hover small id="invocestable" sort-by="ID" small label="Table Options"
                  :items=achievements :fields="[
                          {  key: 'id', thClass: 'd-none', tdClass: 'd-none' },
                          {  key: 'applyDate', label: '当期', thClass: 'text-center', tdClass: 'text-center' },
                          {  key: 'monthlySales', label: '当期累計', thClass: 'text-center', tdClass: 'text-center' },
                          {  key: 'monthlyProfit', label: '粗利額', thClass: 'text-center', tdClass: 'text-center' },
                          {  key: 'monthlyCostRate', label: '粗利率', thClass: 'text-center', tdClass: 'text-center' },
                        ]">
                  <template v-slot:cell(monthlyCostRate)="data">
                    {{monthlyCostRate(data.item.monthlyProfit,data.item.monthlySales)}}%
                    <!-- {{data.item.monthlyCostRate}}% -->
                  </template>
                </b-table>
              </b-card>
            </b-col>
            <b-col></b-col>
          </b-row>
        </div>
      </div>

    </div>

    <script>
      const router = new VueRouter({
      })
      var app = new Vue({
        el: '#app',
        router,
        data: {
          achievements: [],
          year: null,
          month: null,
        },
        methods: {
          getAchievements: async function (year = null, month = null) {
            self = this;
            url = '/v1/achievements-group'
            // url = '/v1/achievements'
            await axios.get(url, {
              params: {
                year: year,
                month: month,
              }
            })
              .then(function (response) {
                console.log(response);
                self.achievements = response.data;
                // 原価率計算
                // let achievements = self.achievements;
                // achievements.map(achieve => {
                //   achieve['monthlyCostRate'] = Math.round(achieve['monthlyProfit'] / achieve['monthlySales'] * 100);
                // });
                // self.achievements = achievements;
              });
          },
          monthlyCostRate: function (monthlyProfit, monthlySales) {
            return Math.round(monthlyProfit / monthlySales * 100);
          },
        },
        mounted: function () {
          document.querySelector('title').textContent = '請求実績';
          // 今月を含めた１年分のデータ取得のため
          let today = new Date();
          this.year = today.getFullYear() - 1;
          this.month = today.getMonth() + 2;
          this.getAchievements(this.year, this.month);
        },
        computed: {
          pageName() {
            if (this.$route.query.page == undefined) return 'index';
            return this.$route.query.page;
          },
          modeName() {
            return localStorage.getItem('wMode');
          },
        }
      });
    </script>

    <% endblock %>